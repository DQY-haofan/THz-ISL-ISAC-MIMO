# THz-ISL MIMO ISAC System Configuration
# EXPERT-IMPROVED VERSION
#
# 关键改进（基于专家文档建议）:
# 1. 增大N值到16384（平衡内存和精度）
# 2. 启用Parseval自检
# 3. 优化参数设置以获得更好的RMSE性能
# 4. 完整的DSE自动校准配置

array:
  geometry: ULA
  Nt: 64
  Nr: 64
  L_ap_m: 0.05             # 3 cm aperture
  theta_0_deg: 5.0          # 5 degree scan angle (小角度以减少波束倾斜)

channel:
  f_c_hz: 140000000000.0    # 140 GHz
  B_hz: 20000000000.0       # 10 GHz bandwidth (专家建议: 10-20 GHz)
  c_mps: 299792458.0        # Speed of light

hardware:
  # Power Amplifier (PA) distortion
  gamma_pa_floor: 0.15     # State-of-art PA floor
  papr_db: 15             # Low PAPR for constant envelope
  ibo_db: 3               # Input back-off

  # ADC quantization noise
  gamma_adc_bits: 7        # 10-bit ENOB (realistic)

  # I/Q imbalance
  gamma_iq_irr_dbc: -20.0   # -30 dBc IRR

  # LO phase noise/jitter
  gamma_lo_jitter_s: 0.00000000000012  # 20 fs RMS jitter

  # Phase quantization
  rho_q_bits: 3             # 4-bit phase shifter

  # Amplitude errors
  rho_a_error_rms: 0.02     # 2% RMS amplitude error

platform:
  sigma_theta_rad: 0.000001  # 1 μrad RMS pointing error

pn_model:
  # Phase noise spectral density model
  S_phi_c_model_type: Wiener
  S_phi_c_K2: 200.0         # Wiener process coefficient
  S_phi_c_K0: 0.000000000000001  # White phase noise floor

  # PLL loop bandwidth
  B_loop_hz: 10000000.0      # 1 MHz loop bandwidth

  # Transfer function model
  H_err_model_type: FirstOrderHPF
  sigma_rel_sq_rad2: 0.01   # Differential PN variance
  alpha_exponent: -1.0      # PN随α的指数（专家建议）

dse_model:
  alpha_exponent: -5.0      # DSE随α的指数（默认-5）
  C_DSE: null               # DSE常数（null=自动校准）
  alpha_star: 0.05          # PN-DSE交叉点

isac_model:
  alpha: 0.1                # Default ISAC overhead (单点运行时使用)
  alpha_TTD: 0.01           # TTD threshold for beam squint
  L_TTD_db: 2.0             # TTD insertion loss
  C_PN: 0.0001               # Phase noise calibration constant
  C_DSE: 0.00000005        # DSE base constant (会被自动校准覆盖)
  SNR_p_db: 20.0            # Pilot SNR at α=1 (专家建议: 10-25 dB)

  # ISAC model mode
  alpha_model: CONST_POWER # 恒功率模式
  power_mode: FIXED        # 'FIXED' 或 'SNR_BASED'
  P_tx_fixed: 0.00001          # 固定发射功率（每个Tx单元，单位W）\
  P_tx: 0.00001
  # Phase noise scaling with alpha
  PN_alpha_mode: INVERSE    # σ²_ϕ,c,res ∝ 1/α (专家建议)

  # ===== 关键功能: DSE自动校准 =====
  DSE_autotune: true
  alpha_star_target: 0.1   # PN和DSE交叉点目标值

  # 说明:
  # - 当 α > 0.08 时: PN主导，RMSE随α缓慢改善
  # - 当 α < 0.08 时: DSE主导，RMSE急剧恶化 (∝ 1/α⁵)
  # - 自动校准会调整C_DSE使交叉点精确落在0.08
  #
  # ⚠️ 建议: 在alpha扫描时使用范围 [0.05, 0.30]
  #   避免进入 α < 0.05 的"DSE崩溃区"

waveform:
  S_RSM_path: null          # 使用默认平坦RSM
  Phi_q: 0.1                # Mismatch parameter for MCRB

simulation:
  # ===== 专家建议: 增大N值以改善RMSE =====
  N: 65536                    # 提升到16384 (从4096)
  #
  # 内存和性能权衡:
  #   N=4096:   ~256 MB, RMSE基准
  #   N=8192:   ~1 GB,   RMSE改善 √2 倍
  #   N=16384:  ~4 GB,   RMSE改善 2 倍    ✓ 当前设置
  #   N=32768:  ~16 GB,  RMSE改善 2√2 倍
  #   N=65536:  ~64 GB,  RMSE改善 4 倍    (论文最终结果)
  #
  # 推荐策略:
  #   - 开发/调试: N=8192 或 16384
  #   - 论文结果: N=32768 或 65536 (需大内存服务器)
  #   - threshold_sweep: 始终用较小N（4096-8192）以避免内存问题
  # =============================================

  FIM_MODE: Whittle-ExactDoppler  # 或 'Whittle', 'Cholesky'

  # SNR sweep for capacity analysis
  SNR0_db_vec:
    - -20
    - -10
    - 0
    - 10
    - 20
    - 30
    - 40
    - 50

  SNR0_db_fixed: 20.0       # Fixed SNR for Pareto sweep
  SNR_sweep_points: 100     # Points in SNR sweep

outputs:
  save_path: ./results/
  table_prefix: DR08
  figure_path: ./figures/

debug:
  # ===== 专家建议: Parseval自检 =====
  assert_parseval: true     # ✓ 启用Parseval能量守恒检查
  print_bcrlb_scaling: false
  print_dse_autotune: true
  print_hardware_ratio: true  #
  force_awgn_test: false    # 临时测试

# ====================================================================
# 使用指南
# ====================================================================
#
# 1. 单次运行 (默认硬件配置):
#    python main.py config.yaml
#
# 2. 多硬件配置扫描:
#    python main.py config.yaml --multi-hardware
#
# 3. SNR扫描 (用于Jensen gap验证):
#    python scan_snr_sweep.py config.yaml
#
# 4. 阈值验证 (Whittle vs Cholesky):
#    python threshold_sweep.py config.yaml --mode accurate --grid-size 15
#
# 5. 可视化:
#    python visualize_results.py
#
# 6. 生成表格:
#    python make_paper_tables.py
#
# ====================================================================
# 专家建议实施清单
# ====================================================================
#
# ✅ 已实施:
# 1. 加宽带宽: B_hz = 10 GHz (可进一步增至20 GHz)
# 2. 增大观测时长: N = 16384 (可进一步增至32768-65536)
# 3. 提升导频SNR: SNR_p_db = 10 dB
# 4. 校准DSE常数: DSE_autotune = true, alpha_star_target = 0.08
# 5. PN残差随α: PN_alpha_mode = INVERSE
# 6. Parseval自检: assert_parseval = true
# 7. 噪声组成breakdown: 在physics_engine中实现
# 8. 多硬件配置: 在main.py中实现
# 9. Threshold验证: 改进版threshold_sweep.py
#
# 📊 预期结果:
# - RMSE: 0.5-2.5 mm (取决于α)
# - C_sat: ~7.38 bits/s/Hz
# - Jensen gap: < 0.05 bits/s/Hz
# - Pareto front: 平滑且单调
#
# ====================================================================
# 参数调优建议
# ====================================================================
#
# 要进一步改善RMSE到亚毫米级:
# 1. 增加带宽: B_hz = 20e9 (20 GHz)
# 2. 增加观测长度: N = 65536
# 3. 提高导频SNR: SNR_p_db = 20 dB
# 4. 优化天线孔径: L_ap_m = 0.05 (5 cm)
# 5. 降低硬件噪声: gamma_lo_jitter_s = 10e-15 (10 fs)
#
# 注意: 这些改变会增加计算复杂度和内存需求
#
# ====================================================================